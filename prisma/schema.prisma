// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator zod {
  provider = "zod-prisma-types"
}

model Chat {
  id        String   @id @default(cuid())
  name      String ///@zod.string.min(1, { message: "Please enter a chat name" })
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]
}

model Message {
  id        String      @id @default(cuid())
  type      MessageType @default(TEXT)
  role      MessageRole @default(USER)
  content   String      @db.Text ///@zod.string.min(1, { message: "Please enter a message" })
  sql       String?
  results   Json?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId String

  responseTo   Message? @relation("ResponseTo", fields: [responseToId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  responseToId String?

  responses Message[] @relation("ResponseTo")
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum MessageType {
  TEXT
  TABLE
  CHART
}

/// Exposed to AI

model Application {
  id           String            @id @default(cuid())
  amount       Float
  language     Language          @default(ENGLISH)
  status       ApplicationStatus @default(PENDING)
  productLine  ProductLine       @default(INPUT_FINANCING)
  businessLine BusinessLine      @default(SMALL_BUSINESS)
  channel      Channel           @default(ALLIANCE_SERVICES)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  completedAt  DateTime?

  outletBusinessPartner   BusinessPartner @relation("OutletApplications", fields: [outletBusinessPartnerId], references: [id], onDelete: Cascade)
  outletBusinessPartnerId String

  parties Party[]
}

model BusinessPartner {
  id        String              @id @default(cuid())
  type      BusinessPartnerType @default(CUSTOMER)
  firstName String
  lastName  String
  email     String
  phone     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  address   Address @relation(fields: [addressId], references: [id], onDelete: Cascade)
  addressId String

  account            Account?
  parties            Party[]
  outletApplications Application[] @relation("OutletApplications")
}

model Party {
  id        String    @id @default(cuid())
  type      PartyType
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  businessPartner   BusinessPartner @relation(fields: [businessPartnerId], references: [id], onDelete: Cascade)
  businessPartnerId String

  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  applicationId String      @unique
}

model Address {
  id        String   @id @default(cuid())
  street    String
  city      String
  province  String
  postal    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessPartners BusinessPartner[]
}

model Account {
  id        String   @id @default(cuid())
  username  String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessPartner   BusinessPartner @relation(fields: [businessPartnerId], references: [id])
  businessPartnerId String          @unique
}

enum ApplicationStatus {
  PENDING
  APPROVED
  DENIED
}

enum ProductLine {
  INPUT_FINANCING
}

enum BusinessLine {
  SMALL_BUSINESS
  CORPORATE_AND_COMMERCIAL
}

enum Channel {
  ALLIANCE_SERVICES
  JET
  ONLINE_SERVICES
}

enum Language {
  ENGLISH
  FRENCH
}

enum BusinessPartnerType {
  ALLIANCE_PARTNER
  CUSTOMER
}

enum PartyType {
  BORROWER
  GUARANTOR
}
